<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Franklin's Virtues</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#16a34a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="franklin_logo.png">
<style>
  :root{
    --bg:#ffffff;
    --text:#000000;
    --muted:#5f6b73;
    --accent:#16a34a;
    --cell-border:#d6d6d6;
    --comment-border:#000000;
    --cell-size:46px;
    --gap:8px;
    --week-outline: rgba(0,0,0,0.08);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  .wrap{max-width:960px;margin:12px auto;padding:12px 10px 12px 8px;}

  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
  .icon img{width:48px;height:48px;border-radius:10px;}
  .title{font-weight:700;font-size:20px;margin-left:-20px;flex-grow:1;text-align:center;}
  .headerRight{text-align:right;min-width:210px;}

  .cyclesRow{display:flex;gap:8px;align-items:center;margin-top:4px;}
  .cycleBtn{padding:8px 12px;border-radius:10px;border:1px solid var(--cell-border);background:transparent;color:var(--text);cursor:pointer;font-weight:700;}
  .cycleBtn.active{background:var(--text);color:var(--bg);box-shadow:0 6px 18px rgba(0,0,0,0.06);}
  .cycleRange{font-size:13px;color:var(--muted);margin-top:4px;}

  .virtueBlock{margin-bottom:16px;padding:10px 12px;border-radius:12px;position:relative;}
  .virtueBlock.current{box-shadow:0 0 0 4px var(--week-outline) inset;}
  .virtueTitle{font-weight:700;font-size:16px;}
  .virtueDesc{font-style:italic;color:var(--muted);font-size:12px;margin-bottom:6px;}

  .squares{display:flex;gap:var(--gap);}
  .dayCell{width:var(--cell-size);height:var(--cell-size);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;border:1px solid var(--cell-border);background:#fff;box-sizing:border-box;}
  .dayCell.issue .dot{width:12px;height:12px;border-radius:50%;background:#000;}
  .dayCell.success{background:var(--accent);color:#fff;border-color:var(--accent);}
  .dayCell.comment{border:2px solid var(--comment-border);}
  .check{width:18px;height:18px;}
  .tooltip{position:absolute;z-index:50;top:-6px;left:50%;transform:translate(-50%,-100%);background:#111;color:#fff;padding:4px 6px;border-radius:6px;font-size:12px;white-space:nowrap;display:none;}
  .dayCell:hover .tooltip{display:block;}

  .modal{position:fixed;left:0;right:0;top:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:999;padding:12px;}
  .modal .box{background:#fff;padding:14px;border-radius:10px;width:100%;max-width:520px;color:#000;box-shadow:0 12px 40px rgba(0,0,0,0.15);}
  .modal textarea{width:100%;height:120px;border-radius:8px;padding:8px;border:1px solid var(--cell-border);resize:vertical;font-family:inherit;}
  .rowBtn{display:flex;gap:8px;justify-content:flex-end;margin-top:8px;}
  .btn{background:transparent;border:1px solid var(--cell-border);padding:8px 12px;border-radius:8px;color:var(--text);cursor:pointer;}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}

  .topControls{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-bottom:8px;}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="icon"><img src="franklin_logo.png" alt="Franklin logo"></div>
      <div class="title">Franklin's Virtues</div>
      <div class="headerRight">
        <div id="cyclesRow" class="cyclesRow"></div>
        <div id="cycleRange" class="cycleRange"></div>
      </div>
    </header>

    <div class="topControls">
      <button class="btn" id="exportBtn">Export Data</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
      <button class="btn" id="importBtn">Import Data</button>
      <button class="btn" id="clearBtn">Reset All</button>
    </div>

    <div id="virtueContainer"></div>
  </div>

  <div class="modal" id="modal">
    <div class="box">
      <div id="modalTitle" style="font-weight:700;margin-bottom:8px;"></div>
      <textarea id="modalText" placeholder="Write a short reflection..."></textarea>
      <div class="rowBtn">
        <button class="btn" id="modalCancel">Cancel</button>
        <button class="btn primary" id="modalSave">Save</button>
      </div>
    </div>
  </div>

<script>
/* -- Data & config -- */
const virtues = [
  {name:"Temperance",desc:"Eat not to dullness; drink not to elevation."},
  {name:"Silence",desc:"Speak not but what may benefit others or yourself; avoid trifling conversation."},
  {name:"Order",desc:"Let all your things have their places; let each part of your business have its time."},
  {name:"Resolution",desc:"Resolve to perform what you ought; perform without fail what you resolve."},
  {name:"Frugality",desc:"Make no expense but to do good to others or yourself; waste nothing."},
  {name:"Industry",desc:"Lose no time; be always employed in something useful; cut off all unnecessary actions."},
  {name:"Sincerity",desc:"Use no hurtful deceit; think innocently and justly, and, if you speak, speak accordingly."},
  {name:"Justice",desc:"Wrong none by doing injuries, or omitting the benefits that are your duty."},
  {name:"Moderation",desc:"Avoid extremes; forbear resenting injuries so much as you think they deserve."},
  {name:"Cleanliness",desc:"Tolerate no uncleanliness in body, clothes, or habitation."},
  {name:"Tranquillity",desc:"Be not disturbed at trifles, or at accidents common or unavoidable."},
  {name:"Chastity",desc:"Rarely use venery but for health or offspring, never to dullness, weakness, or the injury of your own or another’s peace or reputation."},
  {name:"Humility",desc:"Imitate Jesus and Socrates."}
];

const cycleStart = new Date("2025-11-10T00:00:00Z");
const weeksPerCycle = 13;
const cyclesPerYear = 4;

function storageKey(cycle){return`franklin_cycle_${cycle}`;}
function initCycle(cycle){
  const k=storageKey(cycle);
  if(!localStorage.getItem(k)){
    const data={weeks:Array.from({length:13},()=>Array.from({length:7},()=>({state:0,comment:""})))};
    localStorage.setItem(k,JSON.stringify(data));
  }
}
function loadCycle(cycle){initCycle(cycle);return JSON.parse(localStorage.getItem(storageKey(cycle)));}
function saveCycle(cycle,data){localStorage.setItem(storageKey(cycle),JSON.stringify(data));}

function cycleDateRange(cycle){
  const s=new Date(cycleStart);
  s.setDate(s.getDate()+(cycle-1)*weeksPerCycle*7);
  const e=new Date(s);e.setDate(e.getDate()+weeksPerCycle*7-1);
  return{start:s,end:e};
}
function formatDMY(d){const dt=new Date(d);return `${dt.getDate().toString().padStart(2,'0')}/${(dt.getMonth()+1).toString().padStart(2,'0')}/${dt.getFullYear()}`;}
function currentWeekIndexInCycle(cycle){
  const now=new Date();
  const{start,end}=cycleDateRange(cycle);
  if(now<start)return 0;
  if(now>end)return weeksPerCycle-1;
  const diff=Math.floor((now-start)/(1000*60*60*24));
  return Math.min(weeksPerCycle-1,Math.floor(diff/7));
}

/* -- DOM refs -- */
const container=document.getElementById("virtueContainer");
const cyclesRow=document.getElementById("cyclesRow");
const cycleRange=document.getElementById("cycleRange");
const modal=document.getElementById("modal");
const modalText=document.getElementById("modalText");
const modalTitle=document.getElementById("modalTitle");
const modalSave=document.getElementById("modalSave");
const modalCancel=document.getElementById("modalCancel");
const exportBtn=document.getElementById("exportBtn");
const importBtn=document.getElementById("importBtn");
const importFile=document.getElementById("importFile");
const clearBtn=document.getElementById("clearBtn");

let activeCycle=parseInt(localStorage.getItem("franklin_active_cycle")||"1",10);
if(activeCycle<1||activeCycle>4)activeCycle=1;
for(let c=1;c<=4;c++)initCycle(c);

/* -- Render UI -- */
function renderCycleButtons(){
  cyclesRow.innerHTML="";
  for(let c=1;c<=4;c++){
    const b=document.createElement("button");
    b.className="cycleBtn";b.textContent=`Cycle ${c}`;
    if(c===activeCycle)b.classList.add("active");
    b.onclick=()=>{activeCycle=c;localStorage.setItem("franklin_active_cycle",c);render();};
    cyclesRow.appendChild(b);
  }
  const{start,end}=cycleDateRange(activeCycle);
  cycleRange.textContent=`Cycle ${activeCycle}: ${formatDMY(start)} – ${formatDMY(end)}`;
}

function render(){
  renderCycleButtons();
  container.innerHTML="";
  const data=loadCycle(activeCycle);
  const current=currentWeekIndexInCycle(activeCycle);
  for(let vi=0;vi<virtues.length;vi++){
    const vb=document.createElement("div");
    vb.className="virtueBlock";
    if(vi===current)vb.classList.add("current");
    vb.innerHTML=`<div class='virtueTitle'>${virtues[vi].name}</div><div class='virtueDesc'>${virtues[vi].desc}</div>`;
    const sq=document.createElement("div");
    sq.className="squares";
    for(let d=0;d<7;d++){
      const cdat=data.weeks[vi][d];
      const cell=document.createElement("div");
      cell.className="dayCell";
      if(cdat.state===1){cell.classList.add("issue");const dot=document.createElement("div");dot.className="dot";cell.appendChild(dot);}
      else if(cdat.state===2){cell.classList.add("success");const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");svg.setAttribute("viewBox","0 0 24 24");svg.classList.add("check");svg.innerHTML='<path fill="white" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>';cell.appendChild(svg);}
      if(cdat.comment)cell.classList.add("comment");
      const tip=document.createElement("div");tip.className="tooltip";tip.textContent=cdat.comment||"Hold to add a note";cell.appendChild(tip);

      let timer=null;const longMs=600;
      function startPress(e){
        if(e.cancelable)e.preventDefault();
        const touchY=e.touches?e.touches[0].clientY:0;
        const nearBottom=window.innerHeight-touchY<80;
        if(nearBottom)return;
        timer=setTimeout(()=>{openComment(vi,d);timer=null;},longMs);
      }
      function endPress(e){if(timer){clearTimeout(timer);timer=null;toggleState(vi,d);}}
      cell.addEventListener("touchstart",startPress,{passive:false});
      cell.addEventListener("touchend",endPress);
      cell.addEventListener("mousedown",(ev)=>{if(ev.buttons===1)startPress(ev);});
      cell.addEventListener("mouseup",endPress);
      cell.addEventListener("mouseleave",()=>{if(timer){clearTimeout(timer);timer=null;}});
      sq.appendChild(cell);
    }
    vb.appendChild(sq);
    container.appendChild(vb);
  }
}

/* -- Actions -- */
function toggleState(vi,d){
  const data=loadCycle(activeCycle);
  data.weeks[vi][d].state=(data.weeks[vi][d].state+1)%3;
  saveCycle(activeCycle,data);
  render();
}
function openComment(vi,d){
  const data=loadCycle(activeCycle);
  modalTitle.textContent=`${virtues[vi].name} — ${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][d]}`;
  modalText.value=data.weeks[vi][d].comment||"";
  modal.dataset.vi=vi;modal.dataset.d=d;
  modal.style.display="flex";
  setTimeout(()=>modalText.focus(),120);
}
modalSave.onclick=()=>{
  const vi=parseInt(modal.dataset.vi,10),d=parseInt(modal.dataset.d,10);
  const data=loadCycle(activeCycle);
  data.weeks[vi][d].comment=modalText.value.trim();
  saveCycle(activeCycle,data);
  modal.style.display="none";render();
};
modalCancel.onclick=()=>modal.style.display="none";

/* -- Export / Import / Reset -- */
function exportData(){
  const exportObj = { meta: { exportedAt: new Date().toISOString() }, storage: {} };
  for(const k in localStorage){
    if(k.startsWith("franklin_")) exportObj.storage[k]=localStorage.getItem(k);
  }
  const blob = new Blob([JSON.stringify(exportObj, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "franklin_backup.json"; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}
function importDataFromFile(file){
  const reader = new FileReader();
  reader.onload = (ev) => {
    try{
      const obj = JSON.parse(ev.target.result);
      if(!obj.storage) throw new Error("Invalid backup file");
      for(const k in obj.storage){
        localStorage.setItem(k, obj.storage[k]);
      }
      alert("Import complete.");
      render();
    }catch(err){ alert("Failed to import: "+err.message); }
  };
  reader.readAsText(file);
}
function resetAll(){
  if(!confirm("Reset all Franklin data? This will delete your cycles and comments."))return;
  for(const k in {...localStorage}){
    if(k.startsWith("franklin_")) localStorage.removeItem(k);
  }
  for(let c=1;c<=4;c++) initCycle(c);
  render();
}

exportBtn.addEventListener("click", exportData);
importBtn.addEventListener("click", ()=>importFile.click());
importFile.addEventListener("change", (ev)=>{ if(ev.target.files.length) importDataFromFile(ev.target.files[0]); ev.target.value=""; });
clearBtn.addEventListener("click", resetAll);

/* -- Initial render -- */
render();

/* -- Service Worker registration (for offline) -- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').then(()=>{console.log('SW registered');}).catch(()=>{console.log('SW failed');});
}
</script>
</body>
</html>
